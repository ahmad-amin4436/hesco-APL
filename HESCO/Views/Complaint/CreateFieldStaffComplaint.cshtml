 @model HESCO.Models.Complaint.ComplaintData

@{
    ViewData["Title"] = "Create FieldStaffComplaint";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-sm-10">
            <div class="card" style="background-color:blanchedalmond">
                <div class="card-body p-3">
                    <h1 style="text-align:center">Create Complaint</h1>

                    <form id="createComplaintForm" asp-action="CreateFieldStaffComplaint" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <!-- Project Dropdown -->
                        @*   <div class="form-group">
                            <label asp-for="Project" class="control-label"></label>
                            <select asp-for="Project" class="form-control select2" id="projectDropdown" asp-items="ViewBag.SelectProject" required>
                                <option value="">Select a Project</option>
                            </select>
                            <span asp-validation-for="Project" class="text-danger"></span>
                        </div>
                        <!-- Hide form initially -->
                        <div id="CreateComplaintForm" style="display: none;"> *@
                        @*    <div class="form-group">
                            <label asp-for="MSN" class="control-label"></label>
                            <input type="text" id="msn" name="MSN" class="form-control typeahead" placeholder="Select MSN" autocomplete="off" />
                            <span asp-validation-for="MSN" class="text-danger"></span>
                        </div>   *@                      
                        @*     <div class="form-group">
                            <label asp-for="MSN" class="control-label"></label>
                            <input asp-for="MSN" class="form-control" readonly />
                            <span asp-validation-for="MSN" class="text-danger"></span>
                        </div> *@

                        @*       <div class="form-group">
                            <label asp-for="SubDiv" class="control-label"></label>
                            <input type="text" id="SubDivName" class="form-control" readonly />
                            <input type="hidden" id="SubDivCode" name="SubDiv" />
                            <span asp-validation-for="SubDiv" class="text-danger"></span>
                        </div> *@
                        <div class="form-group">
                            <label asp-for="Reference_No" class="control-label"></label>
                            <input type="text" id="Reference_No" name="Reference_No" class="form-control typeahead" placeholder="Select Reference No" autocomplete="off" />
                            <span asp-validation-for="Reference_No" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="MSN" class="control-label"></label>
                            <input asp-for="MSN" class="form-control" readonly />
                            <span asp-validation-for="MSN" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Address" class="control-label"></label>
                            <input asp-for="Address" class="form-control" readonly />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                        <input type="hidden" name="SubDivisionCode" id="SubDivisionCode" />
                        <input type="hidden" name="SubDivisionName" id="SubDivisionName" />
                        <div class="form-group">
                            <label class="control-label">Sub Division</label>
                            <input type="text" class="form-control" id="SubDivisionDisplay" readonly />
                        </div>
                        <div class="form-group" id="openDescriptionWrapper">
                            <label asp-for="Open_Description" class="control-label"></label>
                            <input asp-for="Open_Description" class="form-control" maxlength="70" />
                            <span asp-validation-for="Open_Description" class="text-danger"></span>
                        </div>

                        @*   <div class="form-group" id="executedDescriptionWrapper">
                            <label asp-for="Executed_Description" class="control-label"></label>
                            <select asp-for="Executed_Description" class="form-control" id="executedDescriptionDropdown">
                                <option value="">Select Description</option>
                                @foreach (var description in (SelectList)ViewBag.DescriptionList)
                                {
                                    <option value="@description.Value">@description.Text</option>
                                }
                                <option value="other">Other</option>
                            </select>
                            <input type="text" id="executedDescriptionOther" name="OtherExecutedDescription" class="form-control mt-2" style="display:none;" placeholder="Enter other description" />
                            <span asp-validation-for="Executed_Description" class="text-danger"></span>
                        </div> *@
                        <div class="form-group" id="executedDescriptionWrapper">
                            <label asp-for="Executed_Description" class="control-label"></label>
                            <select asp-for="Executed_Description" class="form-control" id="executedDescriptionDropdown">
                                <option value="">Select Description</option>
                                @foreach (var description in (SelectList)ViewBag.DescriptionList)
                                {
                                    <option value="@description.Value" data-id="@description.Value">@description.Text</option>
                                }
                                @* <option value="other" data-id="other">Other</option> *@
                            </select>

                            <!-- Other description input -->
                            @* <input type="text" id="executedDescriptionOther" name="OtherExecutedDescription" class="form-control mt-2" style="display:none;" placeholder="Enter other description" /> *@

                            <!-- Conditional SIM inputs -->
                            <div id="simFields" style="display: none;">
                                <div class="row mt-2">
                                    <!-- Old IMSI Input -->
                                    <div class="col-md-6">
                                        <label for="old_imsi" class="form-label">Old IMSI</label>
                                        <input type="text" id="old_imsi" name="old_imsi" class="form-control"
                                               placeholder="Enter Old IMSI" minlength="18" maxlength="21"
                                               oninput="validateIMSI(this)"
                                               title="Must be 18-21 characters long. If a letter is present, only one is allowed." />
                                    </div>

                                    <!-- Old Telco Dropdown -->
                                    <div class="col-md-6">
                                        <label for="old_telcoSelect" class="form-label">Old Telco</label>
                                        <select id="old_telcoSelect" name="telco_old" class="form-control">
                                            <option value="">Select Telco</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mt-2">
                                    <!-- New IMSI Input -->
                                    <div class="col-md-6">
                                        <label for="new_imsi" class="form-label">New IMSI</label>
                                        <input type="text" id="new_imsi" name="new_imsi" class="form-control"
                                               placeholder="Enter New IMSI" minlength="18" maxlength="21"
                                               oninput="validateIMSI(this)"
                                               title="Must be 18-21 characters long. If a letter is present, only one is allowed." />
                                    </div>

                                    <!-- New Telco Dropdown -->
                                    <div class="col-md-6">
                                        <label for="new_telcoSelect" class="form-label">New Telco</label>
                                        <select id="new_telcoSelect" name="telco_new" class="form-control">
                                            <option value="">Select Telco</option>
                                        </select>
                                    </div>
                                </div>
                            </div>



                            <span asp-validation-for="Executed_Description" class="text-danger"></span>
                        </div>


                        <div class="form-group">
                            <label asp-for="ComplaintReportedBy" class="control-label"></label>
                            <select asp-for="ComplaintReportedBy" class="form-control" id="reportedbyDropdown" required>
                                <option value="">Select option</option>
                                <option value="0">Self</option>
                                <option value="Hesco LS">Hesco LS</option>
                                <option value="Hesco MI">Hesco MI</option>
                                <option value="Hesco SDO">Hesco SDO</option>
                                <option value="Hesco XEN">Hesco XEN</option>
                                <option value="Hesco SE">Hesco SE</option>
                                <option value="Hesco PIU">Hesco PIU</option>
                            </select>
                            <span asp-validation-for="ComplaintReportedBy" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Status" class="control-label"></label>
                            <select asp-for="Status" class="form-control" id="statusDropdown">
                                <option value="1">Executed</option>
                                <option value="2">Reinstalled/Replaced</option>
                                <option value="6">To be Removed</option>
                            </select>
                            <span asp-validation-for="Status" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Remarks" class="control-label">Remarks</label>
                            <input asp-for="Remarks" class="form-control" />
                            <span asp-validation-for="Remarks" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Location URL</label>
                            <input asp-for="URL" class="form-control" />
                            <span asp-validation-for="URL" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="ComplaintImages">Attach Photos</label>
                            <input type="file" id="ComplaintImages" name="ComplaintImages" multiple onchange="validateFiles(this.files)" />
                        </div>
                        <div class="form-group">
                            <input type="submit" id="complaintformbtn" value="Create" class="btn btn-primary" />
                        </div>
                        @* </div> <!-- END CreateComplaintForm --> *@
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div>
        <a href="@Url.Action("ViewComplaint", "Complaint")" class="btn btn-success">Back to List</a>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.3.0/typeahead.bundle.min.js"></script>
    <script>

        function validateIMSI(input) {
            const value = input.value;
            const letterMatches = value.match(/[A-Za-z]/g);
            const hasInvalidChars = /[^A-Za-z0-9]/.test(value);
            const isCorrectLength = value.length >= 18 && value.length <= 21;
            const letterCount = letterMatches ? letterMatches.length : 0;

            if (!isCorrectLength) {
                input.setCustomValidity("Length must be between 18 and 21 characters.");
            } else if (hasInvalidChars) {
                input.setCustomValidity("Only letters and digits are allowed.");
            } else if (letterCount > 1) {
                input.setCustomValidity("Only one alphabet character is allowed.");
            } else {
                input.setCustomValidity(""); // ✅ Valid input
            }
        }
                      const OLD_IMSI_FROM_MODEL = '@Model.Old_Imsi';
        const NEW_IMSI_FROM_MODEL = '@Model.New_Imsi';
        const TELCO_OLD_FROM_MODEL = '@Model.Telco_Old';
        const TELCO_NEW_FROM_MODEL = '@Model.Telco_New';
        const EXECUTED_DESCRIPTION_ID = '@Model.Executed_Description'; // e.g. 12

        $(document).ready(function () {
            loadTelcos('#old_telcoSelect', TELCO_OLD_FROM_MODEL);
            loadTelcos('#new_telcoSelect', TELCO_NEW_FROM_MODEL);

            // Check description dropdown and model data on page load
            handleSimFieldDisplay();

            // Bind change event to dropdown
            $('#executedDescriptionDropdown').on('change', function () {
                handleSimFieldDisplay();
            });
        });

        function loadTelcos(selectId, selectedText) {
            $.ajax({
                url: '/Complaint/GetTelcos',
                type: 'GET',
                data: { query: '' },
                success: function (data) {
                    const $dropdown = $(selectId);
                    $dropdown.empty();
                    $dropdown.append('<option value="">Select Telco</option>');

                    data.forEach(function (item) {
                        const isSelected = selectedText && item.text.trim() === selectedText.trim();
                        $dropdown.append(
                            $('<option></option>')
                                .val(item.value)
                                .text(item.text)
                                .prop('selected', isSelected)
                        );
                    });
                },
                error: function (xhr) {
                    console.error("Error loading telcos:", xhr.responseText);
                }
            });
        }

               function handleSimFieldDisplay() {
            const dropdown = document.getElementById("executedDescriptionDropdown");
            const simFields = document.getElementById("simFields");
            const oldSim = document.getElementById("old_imsi");
            const newSim = document.getElementById("new_imsi");
              const telcoold = document.getElementById("old_telcoSelect");
            const telconew = document.getElementById("new_telcoSelect");

            const selectedId = dropdown.value;
            const selectedText = dropdown.options[dropdown.selectedIndex]?.text?.trim();

            // Show SIM fields only if selected status is "Communication issue - SIM Replaced"
            const showSimFields = selectedId === "12" && selectedText === "Communication issue - SIM Replaced";

            if (showSimFields) {
                simFields.style.display = "block";

                // Populate fields only if they are empty
                if (!oldSim.value) oldSim.value = OLD_IMSI_FROM_MODEL || "";
                if (!newSim.value) newSim.value = NEW_IMSI_FROM_MODEL || "";

                oldSim.required = true;
                newSim.required = true;
                telcoold.required = true;
                 telconew.required = true;

            } else {
                simFields.style.display = "none";

                // Clear all related fields
                oldSim.required = false;
                newSim.required = false;

                //$('#old_telcoSelect, #new_telcoSelect').val('');
            }
        }
        $(document).ready(function () {
            // // Initially hide the complaint form
            // $("#CreateComplaintForm").hide();

            // // Event handler for project selection
            // $("#projectDropdown").change(function () {
            //     var projectId = $(this).val(); // Get selected project ID
            //     $("#msn").val(""); // Clear msn input
            //     $("#msn").typeahead('destroy'); // Destroy previous Typeahead instance

            //     if (projectId) {
            //         $("#CreateComplaintForm").show(); // Show form when a project is selected


            // Initialize Bloodhound (Typeahead's suggestion engine) with projectId filter
             var referenceNos = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('text'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/Complaint/GetReferenceNos?query=%QUERY',
                wildcard: '%QUERY'
            }
        });
                      $('#Reference_No').typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        name: 'referenceNos',
                        display: 'text',
                        source: referenceNos
                    }).on('typeahead:select', function (ev, suggestion) {
                        var selectedValue = suggestion.value;
                        $(this).typeahead('val', suggestion.text); // Set selected value

                        // Fetch and populate MSN and SubDiv
                              $.ajax({
            url: '/Complaint/GetMSNAndAddressByReferenceNo',
            type: 'GET',
            data: { referenceNoId: selectedValue },  // <- was referenceNoId
            success: function (data) {
                $("input[name='MSN']").val(data.msn);
                $("input[name='Address']").val(data.address);
                     var subdivDisplay = data.subdiv_code + ' - ' + data.subdiv_name;
        $("#SubDivisionDisplay").val(subdivDisplay);

             $("#SubDivisionCode").val(data.subdiv_code);
        $("#SubDivisionName").val(data.subdiv_name);
            },
            error: function () {
                alert("Failed to fetch MSN and address. Please try again.");
            }
        });

                    });
            var MSNs = new Bloodhound({
                        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('text'),
                        queryTokenizer: Bloodhound.tokenizers.whitespace,
                        remote: {
                    url: '/Complaint/GetMSNs?query=%QUERY',
                            wildcard: '%QUERY'
                        }
                    });

                    // Initialize Typeahead on msn input
                    $('#msn').typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        name: 'MSNs',
                        display: 'text',
                        source: MSNs
                    }).on('typeahead:select', function (ev, suggestion) {
                        // When an item is selected from the Typeahead suggestions
                        var selectedValue = suggestion.value;

                        // Set the selected value into the input field
                        $(this).typeahead('val', suggestion.text);
                    });

            //     } else {
            //         $("#CreateComplaintForm").hide(); // Hide form if no project is selected
            //     }
            // });

            // Ensure form validation before submission
            $("#createComplaintForm").submit(function () {
                var refno = $("#Reference_No").val();
                if (refno === "") {
                    alert("No Reference No is selected.");
                    return false;
                }
                return true;
            });
            // Function to handle executed description input visibility
            function handleExecutedDescriptionInput() {
                var selectedValue = $("#executedDescriptionDropdown").val();
                if (selectedValue === "other") {
                    $("#executedDescriptionOther").show();
                } else {
                    $("#executedDescriptionOther").hide();
                }
            }
            //Set the selected value in hidden input
            $('#createComplaintForm').submit(function () {
                var selectedValue = $("#executedDescriptionDropdown").val();
                if (selectedValue === "other") {
                    var otherDescription = $("#executedDescriptionOther").val();
                    if (otherDescription.trim() !== "") {
                        $("#executedDescriptionDropdown").val(otherDescription);
                    } else {
                        alert('Please enter a description if you select "Other".');
                        return false;
                    }
                }
            });
            // Show/Hide Closed_Description and Executed_Description based on Status
            function toggleDescriptionFields() {
                var status = $("#statusDropdown").val();
                if (status == "0") {
                    $("#openDescriptionWrapper").show();
                    $("#executedDescriptionWrapper").hide();
                    $('#executedDescriptionDropdown').removeAttr('required');
                } else if (status == 1 || status == 6) {
                    $("#openDescriptionWrapper").hide();
                    $("#executedDescriptionWrapper").show();
                    $('#executedDescriptionDropdown').attr('required', true);
                } else {
                    $("#openDescriptionWrapper").hide();
                    $("#executedDescriptionWrapper").hide();
                    $('#executedDescriptionDropdown').removeAttr('required');
                }
                handleExecutedDescriptionInput(); // Ensure the executed description field is correctly toggled
            }
            // Initial check and event binding
            toggleDescriptionFields();
            $("#statusDropdown").change(function () {
                toggleDescriptionFields();
            });
            $("#executedDescriptionDropdown").change(function () {
                handleExecutedDescriptionInput();
            });
            // Ensure at least one file is selected if status is 1 (executed)
            $('#complaintformbtn').on('click', function (e) {
                const status = $('#statusDropdown').val(); // Assuming you have a dropdown with id 'Status'
                const files = $('#ComplaintImages')[0].files;

                if ((status == 1 || status == 6) && files.length === 0) {
                    e.preventDefault();
                    alert('You must attach at least one photo when the status is Executed or To be removed.');
                }
            });

        });
        function validateFiles(files) {
            var allowedExtensions = ['.png', '.jpeg', '.jpg', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.xml'];
            for (var i = 0; i < files.length; i++) {
                var fileExtension = files[i].name.split('.').pop().toLowerCase();
                if (allowedExtensions.indexOf('.' + fileExtension) === -1) {
                    alert('Invalid file extension: ' + files[i].name);
                    document.getElementById('ComplaintImages').value = ''; // Clear the input
                    return;
                }
            }
        }


    </script>
    <style>
        /* Add the custom CSS here */

        /* Typeahead dropdown container */
        .tt-menu {
            background-color: white; /* Set background color */
            border: 1px solid #ccc; /* Add border */
            border-radius: 4px; /* Slight rounding of corners */
            padding: 8px; /* Add some padding */
            width: 100%; /* Ensure it matches the input width */
            max-height: 200px; /* Limit the height */
            overflow-y: auto; /* Add scroll if necessary */
            z-index: 1000; /* Make sure it's on top of other elements */
        }

        /* Typeahead dropdown item */
        .tt-suggestion {
            padding: 8px; /* Add padding inside each item */
            cursor: pointer; /* Show pointer cursor on hover */
        }

            /* Highlight the selected item */
            .tt-suggestion.tt-cursor {
                background-color: #007bff; /* Background color on hover */
                color: white; /* Text color on hover */
            }

        /* Ensure the dropdown appears in the correct location */
        .twitter-typeahead {
            width: 100%; /* Ensure the dropdown width matches the input width */
        }

        /* Adjust the input to not overlap with the dropdown */
        .tt-hint {
            color: #999; /* Set hint color */
        }
    </style>
}
