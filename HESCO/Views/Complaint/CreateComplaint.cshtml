 @model HESCO.Models.Complaint.ComplaintData

@{
    ViewData["Title"] = "Create Complaint";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-sm-10">
            <div class="card" style="background-color:blanchedalmond">
                <div class="card-body p-3">
                    <h1 style="text-align:center">Create Complaint</h1>

                    <form id="createComplaintForm" asp-action="CreateComplaint" enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    @*     <!-- Project Dropdown -->
                        <div class="form-group">
                            <label asp-for="Project" class="control-label"></label>
                            <select asp-for="Project" class="form-control select2" id="projectDropdown" asp-items="ViewBag.SelectProject" required>
                                <option value="">Select a Project</option>
                            </select>
                            <span asp-validation-for="Project" class="text-danger"></span>
                        </div>
                        <!-- Hide form initially -->
                        <div id="CreateComplaintForm" style="display: none;"> *@
                        <div class="form-group">
                            <label asp-for="Reference_No" class="control-label"></label>
                            <input type="text" id="Reference_No" name="Reference_No" class="form-control typeahead" placeholder="Select Reference No" autocomplete="off" />
                            <span asp-validation-for="Reference_No" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="MSN" class="control-label"></label>
                            <input asp-for="MSN" class="form-control" readonly />
                            <span asp-validation-for="MSN" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Address" class="control-label"></label>
                            <input asp-for="Address" class="form-control" readonly />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                        <input type="hidden" name="SubDivisionCode" id="SubDivisionCode" />
                        <input type="hidden" name="SubDivisionName" id="SubDivisionName" />
                        <div class="form-group">
                            <label class="control-label">Sub Division</label>
                            <input type="text" class="form-control" id="SubDivisionDisplay" readonly />
                        </div>

                        
                     @*    <div class="form-group">
                            <label asp-for="SubDiv" class="control-label"></label>
                            <input asp-for="SubDiv" class="form-control" />
                            <span asp-validation-for="SubDiv" class="text-danger"></span>
                        </div> *@

                        <div class="form-group">
                            <label asp-for="Open_Description" class="control-label"></label>
                            <input asp-for="Open_Description" class="form-control" maxlength="70" required/>
                            <span asp-validation-for="Open_Description" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="ComplaintReportedBy" class="control-label"></label>
                            <select asp-for="ComplaintReportedBy" class="form-control" id="reportedbyDropdown" required>
                                <option value="">Select option</option>
                                <option value="0">Self</option>
                                    <option value="Hesco LS">Hesco LS</option>
                                    <option value="Hesco MI">Hesco MI</option>
                                    <option value="Hesco SDO">Hesco SDO</option>
                                    <option value="Hesco XEN">Hesco XEN</option>
                                    <option value="Hesco SE">Hesco SE</option>
                                    <option value="Hesco PIU">Hesco PIU</option>
                            </select>
                            <span asp-validation-for="ComplaintReportedBy" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Location URL</label>
                            <input asp-for="URL" class="form-control" />
                            <span asp-validation-for="URL" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label for="ComplaintImages">Attach Photos</label> <br />
                            <input type="file" id="ComplaintImages" name="ComplaintImages" multiple onchange="validateFiles(this.files)" />
                        </div>
                        <div class="form-group">
                            <input type="submit" value="Create" class="btn btn-primary" />
                        </div>
                        @* </div> <!-- END CreateComplaintForm --> *@
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div>
        <a href="@Url.Action("ViewComplaint", "Complaint")" class="btn btn-success">Back to List</a>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.3.0/typeahead.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            // // Initially hide the complaint form
            // $("#CreateComplaintForm").hide();

            // // Event handler for project selection
            // $("#projectDropdown").change(function () {
            //     var projectId = $(this).val(); // Get selected project ID
            //     $("#msn").val(""); // Clear msn input
            //     $("#msn").typeahead('destroy'); // Destroy previous Typeahead instance

            //     if (projectId) {
            //         $("#CreateComplaintForm").show(); // Show form when a project is selected

                    // Initialize Bloodhound (Typeahead's suggestion engine) with projectId filter
                           var referenceNos = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('text'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/Complaint/GetReferenceNos?query=%QUERY',
                wildcard: '%QUERY'
            }
        });


                    // Initialize Typeahead on Reference_No input
                    $('#Reference_No').typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        name: 'referenceNos',
                        display: 'text',
                        source: referenceNos
                    }).on('typeahead:select', function (ev, suggestion) {
                        var selectedValue = suggestion.value;
                        $(this).typeahead('val', suggestion.text); // Set selected value

                        // Fetch and populate MSN and SubDiv
                              $.ajax({
            url: '/Complaint/GetMSNAndAddressByReferenceNo',
            type: 'GET',
            data: { referenceNoId: selectedValue },  // <- was referenceNoId
            success: function (data) {
                $("input[name='MSN']").val(data.msn);
                $("input[name='Address']").val(data.address);
                     var subdivDisplay = data.subdiv_code + ' - ' + data.subdiv_name;
        $("#SubDivisionDisplay").val(subdivDisplay);

             $("#SubDivisionCode").val(data.subdiv_code);     
        $("#SubDivisionName").val(data.subdiv_name);
            },
            error: function () {
                alert("Failed to fetch MSN and address. Please try again.");
            }
        });

                    });

                    var MSNs = new Bloodhound({
                        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('text'),
                        queryTokenizer: Bloodhound.tokenizers.whitespace,
                        remote: {
                    url: '/Complaint/GetMSNs?query=%QUERY', // Pass projectId
                            wildcard: '%QUERY'
                        }
                    });

                    // Initialize Typeahead on msn input
                    $('#msn').typeahead({
                        hint: true,
                        highlight: true,
                        minLength: 1
                    }, {
                        name: 'MSNs',
                        display: 'text',
                        source: MSNs
                    }).on('typeahead:select', function (ev, suggestion) {
                        // When an item is selected from the Typeahead suggestions
                        var selectedValue = suggestion.value;

                        // Set the selected value into the input field
                        $(this).typeahead('val', suggestion.text);
                    });

            //     } else {
            //         $("#CreateComplaintForm").hide(); // Hide form if no project is selected
            //     }
            // });

            // Ensure form validation before submission
            $("#createComplaintForm").submit(function () {
                var msn = $("#msn").val();
                if (msn === "") {
                    alert("No MSN is selected.");
                    return false;
                }
                return true;
            });
        });     

        function validateFiles(files) {
            var allowedExtensions = ['.png', '.jpeg', '.jpg', '.pdf', '.doc', '.docx', '.xls', '.xlsx', '.xml'];
            for (var i = 0; i < files.length; i++) {
                var fileExtension = files[i].name.split('.').pop().toLowerCase();
                if (allowedExtensions.indexOf('.' + fileExtension) === -1) {
                    alert('Invalid file extension: ' + files[i].name);
                    document.getElementById('ComplaintImages').value = ''; // Clear the input
                    return;
                }
            }
        }
    </script>
    <style>
        /* Add the custom CSS here */

        /* Typeahead dropdown container */
        .tt-menu {
            background-color: white; /* Set background color */
            border: 1px solid #ccc; /* Add border */
            border-radius: 4px; /* Slight rounding of corners */
            padding: 8px; /* Add some padding */
            width: 100%; /* Ensure it matches the input width */
            max-height: 200px; /* Limit the height */
            overflow-y: auto; /* Add scroll if necessary */
            z-index: 1000; /* Make sure it's on top of other elements */
        }

        /* Typeahead dropdown item */
        .tt-suggestion {
            padding: 8px; /* Add padding inside each item */
            cursor: pointer; /* Show pointer cursor on hover */
        }

            /* Highlight the selected item */
            .tt-suggestion.tt-cursor {
                background-color: #007bff; /* Background color on hover */
                color: white; /* Text color on hover */
            }

        /* Ensure the dropdown appears in the correct location */
        .twitter-typeahead {
            width: 100%; /* Ensure the dropdown width matches the input width */
        }

        /* Adjust the input to not overlap with the dropdown */
        .tt-hint {
            color: #999; /* Set hint color */
        }
    </style>
}