@model HESCO.Models.UserData

@{
    ViewData["Title"] = "Edit User Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .tree-toggle {
        cursor: pointer;
        margin-right: 5px;
        font-weight: bold;
        color: #007bff;
    }

        .tree-toggle:hover {
            color: #0056b3;
        }

    ul.tree, ul.tree ul {
        list-style-type: none;
        padding-left: 20px;
    }
</style>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6 col-sm-10">
            <div class="card" style="background-color:blanchedalmond">
                <div class="card-body p-3">
                    <h1 style="text-align:center">Update User</h1>
                    <hr />
                    <form asp-action="EditUserDetails" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" asp-for="UserId" />
                        <div class="form-group">
                            <label asp-for="Username" class="control-label"></label>
                            <input asp-for="Username" class="form-control" />
                            <span asp-validation-for="Username" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Name" class="control-label"></label>
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Email" class="control-label"></label>
                            <input asp-for="Email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="ContactNumber" class="control-label"></label>
                            <input asp-for="ContactNumber" class="form-control" />
                            <span asp-validation-for="ContactNumber" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="UserRole" class="control-label"></label>
                            <select asp-for="UserRole" class="form-control" asp-items="ViewBag.userRoles" id="userRoleSelect"></select>

                            <span asp-validation-for="UserRole" class="text-danger"></span>
                        </div>

                        <ul id="rbacTree" class="tree">
                            <!-- Tree will populate here -->
                        </ul>
                        
                        <div id="selectedRightsContainer"></div>


                        <div class="form-group" id="teamDropdown" style="display:none;">
                            <label asp-for="Team" class="control-label"></label>
                            <select asp-for="Team" class="form-control" asp-items="ViewBag.teams"></select>
                            <span asp-validation-for="Team" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <input type="submit" value="Update" class="btn btn-primary" />
                        </div>
                </form>
                </div>
                <div>
                    <a asp-action="ViewUser" asp-controller="Home" class="btn btn-success">Back to List</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
            var previousRights = @Html.Raw(Json.Serialize(ViewBag.UserPreviousRights ?? new List<int>()));
            sessionStorage.setItem("previousRights",previousRights);
                    $("#userRoleSelect").on("change", function () {

                        const selectedRole = $("#userRoleSelect option:selected").text().toLowerCase();
                        const roleId = $(this).val();

                        // Team dropdown logic
                        if (selectedRole === "team lead" || selectedRole === "team member") {
                            $("#teamDropdown").show();
                        } else {
                            $("#teamDropdown").hide().find("select").prop("selectedIndex", -1);
                        }

                        // RBAC logic
                        if (roleId) {
                            GetRightofRoleTree(roleId);
                        } else {
                            $("#rbacTree").empty();
                            previousRights = [];
                        }
                    });
                    let RolesRights = [];
          // 1️⃣ Fetch assigned RBAC IDs for the selected role
        function GetRightofRoleTree(role_id) {
            $.ajax({
                url: '@Url.Action("GetRightofRoleTree", "Home")',
                type: 'GET',
                data: { role_id: role_id },
                success: function (data) {
                    // Convert all IDs to number for safe comparison
                    RolesRights = data.assignedIds.map(Number);
                    if('@ViewBag.UserRole' === role_id){
                        previousRights = sessionStorage.getItem("previousRights");
                    }
                    else{
                        previousRights = '';

                    }
                                ShowRoleRights(); // correct

                    // Render the tree after fetching assigned rights
                   // ShowRoleRights();
                },
                error: function () {
                    alert("Failed to load role rights.");
                }
            });
        }
      
        let treeEventsBound = false;   // prevents double binding

        function ShowRoleRights() {

            $.ajax({
                url: '@Url.Action("GetUserRbacTree", "Home")',
                type: 'GET',
                success: function (data) {

                    /* ---------- BUILD TREE MAP ---------- */
                    const map = {};
                    const roots = [];

                    data.forEach(item => {
                        item.children = [];
                        map[item.id] = item;
                    });

                    data.forEach(item => {
                        if (item.parent_id && map[item.parent_id]) {
                            map[item.parent_id].children.push(item);
                        } else {
                            roots.push(item);
                        }
                    });
                    /* ---------- RENDER TREE ---------- */
                          function renderTree(nodes) {
            let html = "<ul>";

            nodes.forEach(node => {
                const hasChildren = node.children.length > 0;

                // Parent → controller | Child → action
                let label = !node.parent_id
                    ? (node.controller || "")
                    : (node.action || "");
                // Determine if checkbox should be checked
                let isChecked = "";

                if (previousRights.length > 0){
                   isChecked = previousRights.includes(node.id) ? "checked" : "";
                }
                else{
                    isChecked = RolesRights.includes(node.id) ? "checked" : "";
                }
                
                
                html += `<li>`;
                
                // Expand/Collapse icon
                html += hasChildren 
                    ? `<span class="tree-toggle">[+]</span>`
                    : `<span class="tree-spacer"></span>`;
                       if (label === 'Home') {
                        debugger;
                        label = 'Users';
                    }

                // Checkbox + Label
                html += `
                    <input type="checkbox" class="rbac-checkbox" value="${node.id}" ${isChecked}>
                    <label>${label}</label>
                `;

                // Render children recursively
                if (hasChildren) {
                    html += renderTree(node.children);
                }

                html += `</li>`;
            });

            html += "</ul>";
            return html;
        }

                    /* ---------- Insert Tree ---------- */
                    $("#rbacTree").html(renderTree(roots));

                    /* ---------- Collapse sub-levels initially ---------- */
                    $("#rbacTree ul ul").hide();

                    /* -----------------------------------------------------
                       ENSURE EVENTS ARE BOUND ONLY ONCE
                       ----------------------------------------------------- */
                    if (!treeEventsBound) {

                        // Expand / collapse
                        $(document).on("click", ".tree-toggle", function () {
                            const target = $(this).closest("li").children("ul");

                            if (target.is(":visible")) {
                                target.slideUp(150);
                                $(this).text("[+]");
                            } else {
                                target.slideDown(150);
                                $(this).text("[-]");
                            }
                        });

                        // Checkbox logic
                        $(document).on("change", ".rbac-checkbox", function () {
                            const checked = this.checked;

                            // Downward propagation
                            $(this).closest("li").find(".rbac-checkbox")
                                .prop("checked", checked);

                            // Upward propagation
                            if (checked) {
                                $(this).parents("ul")
                                    .prev(".rbac-checkbox")
                                    .prop("checked", true);
                            }
                        });

                        treeEventsBound = true;  // prevent rebinding
                    }
                },
                error: function () {
                    alert("Failed to load RBAC tree.");
                }
            });
        }
        $('form').on('submit', function () {

            // clear previous hidden inputs
            $("#selectedRightsContainer").empty();

            // loop through all checked checkboxes
            $(".rbac-checkbox:checked").each(function () {

                var id = $(this).val();
                var label = $(this).next("label").text().trim();

                // Append to form for model binding
                $("#selectedRightsContainer").append(`
                    <input type="hidden" name="SelectedRights[index].Id" value="${id}">
                    <input type="hidden" name="SelectedRights[index].Label" value="${label}">
                `.replace(/index/g, $("#selectedRightsContainer input").length / 2));
            });

        });

                $(document).ready(function () {
            ShowRoleRights(); // Load initial rights from ViewBag
        });
            // Trigger the change event on page load to set the initial visibility
            //document.getElementById("userRoleSelect").dispatchEvent(new Event("change"));
        </script>
}